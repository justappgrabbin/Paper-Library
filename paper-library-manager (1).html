<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö PAPER Library Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .drop-zone.dragover {
            background: #e7e9fc;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        
        .drop-zone.processing {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .drop-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .drop-text {
            font-size: 1.1em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .drop-hint {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .llama-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            background: #e7f3ff;
            border-left: 4px solid #667eea;
        }
        
        .llama-status.offline {
            background: #ffe7e7;
            border-left-color: #dc3545;
        }
        
        .llama-status.online {
            background: #e7ffe7;
            border-left-color: #28a745;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }
        
        .status-dot.online {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .settings-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .settings-section h3 {
            font-size: 1em;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .setting-row {
            margin-bottom: 10px;
        }
        
        .setting-row label {
            display: block;
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .setting-row input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .stats-panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .library-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h2 {
            color: #667eea;
            font-size: 1.5em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .app-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .app-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .app-card.processing {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .app-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .app-icon {
            font-size: 2em;
        }
        
        .app-title {
            flex: 1;
        }
        
        .app-title h3 {
            font-size: 1.1em;
            color: #212529;
            margin-bottom: 3px;
        }
        
        .app-title .file-name {
            font-size: 0.8em;
            color: #6c757d;
        }
        
        .app-glyphs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .glyph {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .glyph.energy-calm { background: #d1ecf1; color: #0c5460; }
        .glyph.energy-focused { background: #fff3cd; color: #856404; }
        .glyph.energy-energetic { background: #f8d7da; color: #721c24; }
        .glyph.energy-flowing { background: #d4edda; color: #155724; }
        
        .app-description {
            font-size: 0.9em;
            color: #495057;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .app-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .app-actions {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .app-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-edit:hover {
            background: #5568d3;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .processing-log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        .log-entry {
            padding: 5px 0;
            color: #495057;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #667eea;
        }
        
        .close-modal {
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
            background: none;
            border: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95em;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
        }
        
        .glyph-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .glyph-option {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .glyph-option.selected {
            border-color: #667eea;
            background: #e7e9fc;
        }
        
        .glyph-option:hover {
            border-color: #667eea;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö PAPER Library Manager</h1>
            <p>Consciousness-Aware App Organization System</p>
        </div>
        
        <div class="main-grid">
            <div class="upload-panel">
                <div class="drop-zone" id="dropZone">
                    <div class="drop-icon">üìÅ</div>
                    <div class="drop-text">Drop files or folders here</div>
                    <div class="drop-hint">Supports: HTML, JS, Python, TypeScript, ZIP archives</div>
                    <input type="file" id="fileInput" multiple style="display: none;" 
                           accept=".html,.js,.py,.ts,.tsx,.css,.json,.md,.zip">
                </div>
                
                <div class="llama-status offline" id="llamaStatus">
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">LlamaFile: Checking...</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                        Make sure LlamaFile is running on port 8080
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>‚öôÔ∏è Settings</h3>
                    <div class="setting-row">
                        <label>LlamaFile Endpoint</label>
                        <input type="text" id="llamaEndpoint" value="http://localhost:8080">
                    </div>
                    <div class="setting-row">
                        <label>Auto-analyze new files</label>
                        <input type="checkbox" id="autoAnalyze" checked style="width: auto;">
                    </div>
                </div>
                
                <div class="processing-log" id="processingLog" style="display: none;"></div>
            </div>
            
            <div class="stats-panel">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalApps">0</div>
                        <div class="stat-label">Total Apps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="calmApps">0</div>
                        <div class="stat-label">üåä Calm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="energeticApps">0</div>
                        <div class="stat-label">‚ö° Energetic</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="focusedApps">0</div>
                        <div class="stat-label">üî• Focused</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="library-section">
            <div class="section-header">
                <h2>üìñ Your Library</h2>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearLibrary()">üóëÔ∏è Clear All</button>
                    <button class="btn btn-primary" onclick="exportLibrary()">üíæ Export JSON</button>
                </div>
            </div>
            
            <div class="library-grid" id="libraryGrid">
                <div class="empty-state">
                    <div class="empty-state-icon">üìö</div>
                    <h3>Your library is empty</h3>
                    <p>Drop some files above to get started!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit App Details</h2>
                <button class="close-modal" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label>App Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Energy Signature</label>
                    <div class="glyph-selector">
                        <div class="glyph-option" data-energy="calm" onclick="selectEnergy('calm')">
                            üåä Calm<br><small>Gentle, peaceful</small>
                        </div>
                        <div class="glyph-option" data-energy="focused" onclick="selectEnergy('focused')">
                            üî• Focused<br><small>Structured, precise</small>
                        </div>
                        <div class="glyph-option" data-energy="energetic" onclick="selectEnergy('energetic')">
                            ‚ö° Energetic<br><small>Dynamic, intense</small>
                        </div>
                        <div class="glyph-option" data-energy="flowing" onclick="selectEnergy('flowing')">
                            „Ä∞Ô∏è Flowing<br><small>Wavy, adaptive</small>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="editTags" placeholder="meditation, timer, focus">
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // State
        let library = [];
        let currentEditIndex = null;
        let llamaOnline = false;
        
        // Load library from localStorage on start
        function loadLibrary() {
            const saved = localStorage.getItem('paperLibrary');
            if (saved) {
                library = JSON.parse(saved);
                renderLibrary();
                updateStats();
            }
        }
        
        // Save library to localStorage
        function saveLibrary() {
            localStorage.setItem('paperLibrary', JSON.stringify(library));
            updateStats();
        }
        
        // Check LlamaFile status
        async function checkLlamaStatus() {
            const endpoint = document.getElementById('llamaEndpoint').value;
            try {
                const response = await fetch(`${endpoint}/health`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                llamaOnline = response.ok;
            } catch (e) {
                llamaOnline = false;
            }
            
            const statusEl = document.getElementById('llamaStatus');
            const dotEl = document.getElementById('statusDot');
            const textEl = document.getElementById('statusText');
            
            if (llamaOnline) {
                statusEl.className = 'llama-status online';
                dotEl.className = 'status-dot online';
                textEl.textContent = 'LlamaFile: Online ‚úì';
            } else {
                statusEl.className = 'llama-status offline';
                dotEl.className = 'status-dot';
                textEl.textContent = 'LlamaFile: Offline';
            }
        }
        
        // Drag & Drop setup
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            fileInput.value = ''; // Reset input
        });
        
        // Handle uploaded files
        async function handleFiles(files) {
            showLog();
            dropZone.classList.add('processing');
            
            for (const file of files) {
                log(`Processing: ${file.name}`);
                
                if (file.name.endsWith('.zip')) {
                    await handleZipFile(file);
                } else {
                    await handleSingleFile(file);
                }
            }
            
            dropZone.classList.remove('processing');
            saveLibrary();
            renderLibrary();
            log('‚úì All files processed!', 'success');
        }
        
        // Handle ZIP file
        async function handleZipFile(file) {
            try {
                const zip = await JSZip.loadAsync(file);
                log(`Unpacking ZIP: ${file.name}`);
                
                for (const [path, zipEntry] of Object.entries(zip.files)) {
                    if (!zipEntry.dir && isValidFile(path)) {
                        const content = await zipEntry.async('text');
                        await processFileContent(path, content);
                    }
                }
            } catch (error) {
                log(`Error unpacking ${file.name}: ${error.message}`, 'error');
            }
        }
        
        // Handle single file
        async function handleSingleFile(file) {
            if (!isValidFile(file.name)) {
                log(`Skipped: ${file.name} (unsupported type)`, 'error');
                return;
            }
            
            try {
                const content = await file.text();
                await processFileContent(file.name, content);
            } catch (error) {
                log(`Error reading ${file.name}: ${error.message}`, 'error');
            }
        }
        
        // Check if file type is valid
        function isValidFile(filename) {
            const validExtensions = ['.html', '.js', '.py', '.ts', '.tsx', '.css', '.json', '.md'];
            return validExtensions.some(ext => filename.toLowerCase().endsWith(ext));
        }
        
        // Process file content
        async function processFileContent(filename, content) {
            // Quick glyph detection from content
            const quickGlyphs = detectQuickGlyphs(content);
            
            const appData = {
                id: Date.now() + Math.random(),
                filename: filename,
                name: extractName(filename, content),
                description: '',
                energy: quickGlyphs.energy,
                glyphs: quickGlyphs,
                tags: [],
                content: content,
                timestamp: new Date().toISOString()
            };
            
            library.push(appData);
            
            // Auto-analyze with LlamaFile if enabled and online
            if (document.getElementById('autoAnalyze').checked && llamaOnline) {
                await analyzeWithLlama(library.length - 1);
            } else {
                log(`Added: ${filename} (${quickGlyphs.energy})`);
            }
        }
        
        // Quick glyph detection from code analysis
        function detectQuickGlyphs(content) {
            const lower = content.toLowerCase();
            
            // Energy detection
            let energy = 'focused'; // default
            
            if (lower.includes('calm') || lower.includes('gentle') || lower.includes('peace') ||
                lower.includes('meditation') || lower.includes('relax')) {
                energy = 'calm';
            } else if (lower.includes('game') || lower.includes('simulation') || lower.includes('intense') ||
                       lower.includes('dynamic') || lower.includes('particle')) {
                energy = 'energetic';
            } else if (lower.includes('flow') || lower.includes('wave') || lower.includes('smooth') ||
                       lower.includes('rhythm') || lower.includes('adaptive')) {
                energy = 'flowing';
            }
            
            return {
                energy: energy,
                flow: detectFlow(content),
                mood: detectMood(content),
                rhythm: detectRhythm(content)
            };
        }
        
        function detectFlow(content) {
            if (content.includes('grid') || content.includes('structured')) return 'straight';
            if (content.includes('curve') || content.includes('wave')) return 'wavy';
            if (content.includes('spiral') || content.includes('circular')) return 'spiral';
            return 'straight';
        }
        
        function detectMood(content) {
            const lower = content.toLowerCase();
            if (lower.includes('contemplat') || lower.includes('meditat')) return 'contemplative';
            if (lower.includes('creat') || lower.includes('art')) return 'creative';
            if (lower.includes('search') || lower.includes('explore')) return 'searching';
            return 'energetic';
        }
        
        function detectRhythm(content) {
            if (content.includes('continuous') || content.includes('steady')) return 'continuous';
            if (content.includes('burst') || content.includes('pulse')) return 'punctuated';
            return 'continuous';
        }
        
        // Extract name from filename or content
        function extractName(filename, content) {
            // Try to get title from HTML
            const titleMatch = content.match(/<title>(.*?)<\/title>/i);
            if (titleMatch) {
                return titleMatch[1].replace(/[üåüüìÑüéÆ‚ö°]/g, '').trim();
            }
            
            // Try h1
            const h1Match = content.match(/<h1[^>]*>(.*?)<\/h1>/i);
            if (h1Match) {
                return h1Match[1].replace(/<[^>]*>/g, '').replace(/[üåüüìÑüéÆ‚ö°]/g, '').trim();
            }
            
            // Fallback to filename
            return filename.replace(/\.(html|js|py|ts|tsx)$/, '')
                          .replace(/[-_]/g, ' ')
                          .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Analyze with LlamaFile
        async function analyzeWithLlama(index) {
            const app = library[index];
            const endpoint = document.getElementById('llamaEndpoint').value;
            
            log(`üß† Analyzing ${app.filename} with LlamaFile...`);
            
            try {
                const response = await fetch(`${endpoint}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: `Analyze this code and respond ONLY with valid JSON in this exact format:
{
  "description": "brief description of what this code does (max 2 sentences)",
  "energy": "calm|focused|energetic|flowing",
  "tags": ["tag1", "tag2", "tag3"]
}

Code to analyze:
${app.content.substring(0, 2000)}`
                        }],
                        temperature: 0.3,
                        max_tokens: 200
                    })
                });
                
                const data = await response.json();
                const analysis = parseAnalysis(data.choices[0].message.content);
                
                if (analysis) {
                    library[index].description = analysis.description || app.description;
                    library[index].energy = analysis.energy || app.energy;
                    library[index].tags = analysis.tags || [];
                    
                    log(`‚úì Analyzed: ${app.filename} ‚Üí ${analysis.energy}`, 'success');
                } else {
                    log(`‚ö† Could not parse analysis for ${app.filename}`);
                }
            } catch (error) {
                log(`‚úó Analysis failed for ${app.filename}: ${error.message}`, 'error');
            }
            
            saveLibrary();
            renderLibrary();
        }
        
        // Parse LlamaFile analysis
        function parseAnalysis(text) {
            try {
                // Try to extract JSON from text
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {
                console.error('Failed to parse analysis:', e);
            }
            return null;
        }
        
        // Render library
        function renderLibrary() {
            const grid = document.getElementById('libraryGrid');
            
            if (library.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <h3>Your library is empty</h3>
                        <p>Drop some files above to get started!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = library.map((app, index) => `
                <div class="app-card" onclick="viewApp(${index})">
                    <div class="app-header">
                        <div class="app-icon">${getEnergyIcon(app.energy)}</div>
                        <div class="app-title">
                            <h3>${app.name}</h3>
                            <div class="file-name">${app.filename}</div>
                        </div>
                    </div>
                    <div class="app-glyphs">
                        <span class="glyph energy-${app.energy}">
                            ${getEnergyIcon(app.energy)} ${app.energy}
                        </span>
                    </div>
                    <div class="app-description">
                        ${app.description || 'No description yet. Click Edit to add one.'}
                    </div>
                    ${app.tags.length > 0 ? `
                        <div class="app-tags">
                            ${app.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="app-actions">
                        <button class="btn-edit" onclick="editApp(${index}, event)">‚úèÔ∏è Edit</button>
                        <button class="btn-delete" onclick="deleteApp(${index}, event)">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function getEnergyIcon(energy) {
            const icons = {
                calm: 'üåä',
                focused: 'üî•',
                energetic: '‚ö°',
                flowing: '„Ä∞Ô∏è'
            };
            return icons[energy] || 'üî•';
        }
        
        // Update stats
        function updateStats() {
            document.getElementById('totalApps').textContent = library.length;
            document.getElementById('calmApps').textContent = library.filter(a => a.energy === 'calm').length;
            document.getElementById('energeticApps').textContent = library.filter(a => a.energy === 'energetic').length;
            document.getElementById('focusedApps').textContent = library.filter(a => a.energy === 'focused').length;
        }
        
        // Edit app
        function editApp(index, event) {
            event.stopPropagation();
            currentEditIndex = index;
            const app = library[index];
            
            document.getElementById('editName').value = app.name;
            document.getElementById('editDescription').value = app.description;
            document.getElementById('editTags').value = app.tags.join(', ');
            
            // Select current energy
            document.querySelectorAll('.glyph-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.energy === app.energy) {
                    el.classList.add('selected');
                }
            });
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function selectEnergy(energy) {
            document.querySelectorAll('.glyph-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-energy="${energy}"]`).classList.add('selected');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = null;
        }
        
        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (currentEditIndex !== null) {
                const selectedEnergy = document.querySelector('.glyph-option.selected');
                
                library[currentEditIndex].name = document.getElementById('editName').value;
                library[currentEditIndex].description = document.getElementById('editDescription').value;
                library[currentEditIndex].energy = selectedEnergy ? selectedEnergy.dataset.energy : 'focused';
                library[currentEditIndex].tags = document.getElementById('editTags').value
                    .split(',')
                    .map(t => t.trim())
                    .filter(t => t);
                
                saveLibrary();
                renderLibrary();
                closeEditModal();
            }
        });
        
        // Delete app
        function deleteApp(index, event) {
            event.stopPropagation();
            if (confirm(`Delete "${library[index].name}"?`)) {
                library.splice(index, 1);
                saveLibrary();
                renderLibrary();
            }
        }
        
        // View app details
        function viewApp(index) {
            // For now, just open edit modal
            editApp(index, new Event('click'));
        }
        
        // Export library
        function exportLibrary() {
            const manifest = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                apps: library.map(app => ({
                    id: app.id,
                    name: app.name,
                    filename: app.filename,
                    description: app.description,
                    energy: app.energy,
                    glyphs: app.glyphs,
                    tags: app.tags,
                    content: app.content
                }))
            };
            
            const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `paper-library-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('‚úì Library exported!', 'success');
        }
        
        // Clear library
        function clearLibrary() {
            if (confirm('Clear entire library? This cannot be undone!')) {
                library = [];
                saveLibrary();
                renderLibrary();
                log('Library cleared', 'success');
            }
        }
        
        // Logging
        function showLog() {
            document.getElementById('processingLog').style.display = 'block';
        }
        
        function log(message, type = '') {
            const logEl = document.getElementById('processingLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Initialize
        loadLibrary();
        checkLlamaStatus();
        setInterval(checkLlamaStatus, 10000); // Check every 10s
    </script>
</body>
</html>
